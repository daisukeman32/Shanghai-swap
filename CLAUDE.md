# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

**プロジェクト名**: Shanghai-swap（上海スワップゲーム）
**正式タイトル**: 『クラスで一番人気の美少女と入れ替われるパズル～30分間の秘密～』

### ゲームコンセプト
- **ジャンル**: 恋愛ノベル × 上海パズルゲーム
- **コアメカニクス**: 上海パズルをクリアして美少女と入れ替わり、30分間の秘密体験を獲得
- **プラットフォーム**: Electron（クロスプラットフォーム対応）
- **技術スタック**: HTML5, CSS3, JavaScript, React
- **データ管理**: CSV完全外部化（BOM付きUTF-8）
- **セーブシステム**: LocalStorage自動保存（5秒間隔）

### 主要機能
1. **4画面構成**: タイトル → 会話シーン → 上海パズル → ご褒美シーン
2. **上海パズルシステム**: 麻雀牌のマッチング削除ゲーム（3Dレイヤー構造）
3. **CSV完全管理**: 会話、選択肢、キャラクター、パズル配置データをCSVで外部管理
4. **ご褒美システム**: クリア報酬として画像・動画コンテンツを解放
5. **自動セーブ**: 進行状況を5秒ごとに自動保存

### ターゲット層
20-40代男性向け、恋愛シミュレーション × パズルゲーム好き

### 開発状況
現在は仕様書フェーズ。`shanghai_romance_spec.md`に70KB超の完全仕様書が存在。

## Gemini CLI 連携

### トリガー
ユーザーが「Geminiと相談しながら進めて」（または類似表現）とリクエストした場合、Claude はセッション全体を通じて Gemini CLI と協業します。

### 協業時の Claude の役割
- **批判的評価者**: Gemini の提案を鵜呑みにせず、必ず検証・評価する
- **統合責任者**: 複数の視点を統合し、最終判断を行う
- **品質管理者**: 実装の実現可能性、保守性、パフォーマンスを評価

### 協業ワークフロー
1. **PROMPT 準備**: 最新の要件と議論要約を `$PROMPT` に格納
2. **Gemini 呼び出し** (バックグラウンド実行で自動進行):
   ```bash
   gemini <<EOF
   $PROMPT
   
   重要：以下の観点で複数の選択肢を提示してください：
   - 長所と短所を明確に
   - トレードオフを具体的に
   - 実装難易度の評価
   EOF
   ```
   ※ Claude は `run_in_background: true` でGeminiを呼び出し、結果を自動的に取得・評価します
3. **出力形式**:
   ```md
   **Gemini ➜**
   <Gemini からの応答>

   **Claude ➜**
   <評価フレームワークに基づく分析>
   ```

### 📊 Claude の評価フレームワーク
**Claude ➜** セクションは必ず以下の構造に従う：

```
## Gemini提案の評価
✅ **採用可能な要素**: [具体的な良い点]
⚠️ **技術的懸念**: [実装上の問題点やリスク]
🔄 **Claude の代替案**: [独自の第3の選択肢]

## 最終判断
- **採用方針**: [Gemini案/Claude案/折衷案]
- **根拠**: [なぜその判断に至ったか]
- **実装計画**: [具体的な次のステップ]
```

### ⚡ 鵜呑み防止ルール
1. **Gemini の提案をそのまま採用することは禁止**
2. **必ず技術的検証を行う**
3. **独自案の検討を義務化**

## 開発ガイドライン

### アーキテクチャ原則
1. **CSV駆動開発**: すべてのゲームデータはCSVで外部管理
   - 会話データ: `data/conversations.csv`（BOM付きUTF-8必須）
   - キャラクターデータ: `data/characters.csv`
   - パズル配置: `data/shanghai_layouts.csv`
   - ご褒美コンテンツ: `data/rewards.csv`

2. **4画面MVC構造**:
   - **タイトル画面** (`TitleScreen.jsx`): ゲーム開始・継続・ギャラリー
   - **会話シーン** (`ConversationScene.jsx`): CSV読込・選択肢・分岐処理
   - **上海パズル** (`ShanghaiPuzzle.jsx`): 3Dレイヤー構造・マッチング判定
   - **ご褒美シーン** (`RewardScene.jsx`): 画像/動画表示・進行度管理

3. **自動セーブシステム**:
   - LocalStorageに5秒間隔で自動保存
   - 保存データ構造: `{ characterProgress, unlockedRewards, currentScene, timestamp }`

### ファイル構成（予定）
```
Shanghai-swap/
├── src/
│   ├── components/
│   │   ├── TitleScreen.jsx
│   │   ├── ConversationScene.jsx
│   │   ├── ShanghaiPuzzle.jsx
│   │   └── RewardScene.jsx
│   ├── utils/
│   │   ├── csvLoader.js       # CSV読込ユーティリティ
│   │   ├── saveManager.js     # セーブ/ロード管理
│   │   └── shanghaiLogic.js   # パズルロジック
│   └── App.jsx
├── data/
│   ├── conversations.csv
│   ├── characters.csv
│   ├── shanghai_layouts.csv
│   └── rewards.csv
├── assets/
│   ├── images/                # 立ち絵・背景・UI素材
│   ├── videos/                # ご褒美動画
│   └── audio/                 # BGM・効果音
├── public/
└── package.json
```

### CSV仕様重要事項
- **必須エンコーディング**: BOM付きUTF-8（日本語対応）
- **列区切り**: カンマ（`,`）
- **改行**: LF推奨、CRLF許容
- **データ検証**: 起動時に必須列の存在確認

### 上海パズル仕様
- **牌タイプ**: 標準麻雀牌（萬子、筒子、索子、字牌）
- **レイアウト**: 14×8グリッド、5層構造
- **マッチング条件**: 同じ牌2枚、左右どちらかが開放されている
- **クリア条件**: 全牌削除

## 重要な注意事項

- ユーザーが明示的に要求しない限りファイルを作成しない
- 新規ファイル作成より既存ファイルの編集を常に優先する
- コードベース内の既存のコードパターンと規約に従う
- 特に指定がない限り、すべてのコード変更は後方互換性を維持する

## プロジェクト固有の指示

### 段階的開発アプローチ
仕様書（`shanghai_romance_spec.md`）に詳細な段階的開発ロードマップが記載されている：

**Phase 1: プロトタイプ（2-3日）**
- タイトル画面の基本実装
- CSV読込システムの確立
- 会話シーン1キャラ分の実装

**Phase 2: コアゲーム（5-7日）**
- 上海パズルのフル実装（3Dレイヤー、判定ロジック）
- 自動セーブシステム
- ご褒美シーンの基本実装

**Phase 3: コンテンツ拡充（3-5日）**
- 全キャラクター実装（愛莉、夏帆、美月）
- ギャラリー機能
- BGM/効果音統合

**Phase 4: Electron化（2-3日）**
- Electronパッケージング
- クロスプラットフォームビルド
- 最終調整

### Gemini CLI との協業が推奨される場面
- **アーキテクチャ設計**: コンポーネント構造、状態管理方針の検討
- **パズルロジック**: 上海のマッチング判定アルゴリズム設計
- **パフォーマンス最適化**: 大量のCSVデータ読込・レンダリング最適化
- **問題解決**: 技術的な問題が発生した際の複数案検討

### 参照ドキュメント
- **完全仕様書**: `shanghai_romance_spec.md`（70KB、実装サンプルコード含む）
- **Claude協業ガイド**: 本ファイル（CLAUDE.md）
- **Gemini協業ガイド**: `GEMINI.md`

### 重要な制約
- **BOM付きUTF-8厳守**: CSVの文字化け防止のため必須
- **5秒自動セーブ**: ユーザー体験維持のため遵守
- **4画面構造**: タイトル/会話/パズル/ご褒美の4画面を厳守
- **90年代アーケード風UI**: レトロゲーム風のビジュアルデザイン